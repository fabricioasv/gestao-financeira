<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gest√£o Financeira Pessoal</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        .upload-area {
            border: 2px dashed #007bff;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            border-color: #0056b3;
            background-color: #e9ecef;
        }
        
        .upload-area.dragover {
            border-color: #28a745;
            background-color: #d4edda;
        }
        
        .financial-table {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        
        .category-badge {
            font-size: 0.8em;
            padding: 4px 8px;
        }
        
        .value-positive {
            color: #28a745;
            font-weight: bold;
        }
        
        .value-negative {
            color: #dc3545;
            font-weight: bold;
        }
        
        .value-neutral {
            color: #6c757d;
        }
        
        .loading {
            display: none;
        }
        
        .loading.show {
            display: block;
        }
        
        .nav-tabs .nav-link {
            color: #495057;
        }
        
        .nav-tabs .nav-link.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .month-future {
            color: #6c757d !important;
            font-style: italic;
        }
        
        .table-responsive {
            overflow-x: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
        }
        
        .table th, .table td {
            white-space: nowrap;
            min-width: 120px;
            vertical-align: middle;
        }
        
        /* Estilos para fixar as primeiras colunas apenas da tabela principal (financialTable) */
        #financialTable th:first-child, #financialTable td:first-child {
            min-width: 200px;
            position: sticky;
            left: 0;
            background-color: #f8f9fa !important;
            z-index: 1;
            border-right: 2px solid #dee2e6;
        }
        
        #financialTable th:nth-child(2), #financialTable td:nth-child(2) {
            min-width: 100px;
            position: sticky;
            left: 200px;
            background-color: #f8f9fa !important;
            z-index: 1;
            border-right: 2px solid #dee2e6;
        }
        
        /* Melhorar a responsividade da tabela */
        .table-responsive {
            max-height: 600px;
            overflow-y: auto;
        }
        
        /* Estilo para scrollbar personalizada */
        .table-responsive::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        
        .table-responsive::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .table-responsive::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Estilo para meses futuros - melhorar visibilidade */
        .month-future {
            color: #495057 !important;
            font-style: italic;
            background-color: #e9ecef !important;
        }
        
        /* Estilo para c√©lulas de meses futuros */
        .table td.month-future {
            background-color: #e9ecef !important;
            color: #495057 !important;
        }
        
        /* Estilo para cabe√ßalhos de meses futuros */
        .table th.month-future {
            background-color: #6c757d !important;
            color: #ffffff !important;
        }
        
        /* CORRE√á√ÉO ESPEC√çFICA PARA COLUNAS FIXAS - Usar seletores mais espec√≠ficos */
        #financialTable thead tr th:first-child,
        #financialTable thead tr th:nth-child(2) {
            background-color: #343a40 !important;
            color: #ffffff !important;
        }
        
        #financialTable tbody tr td:first-child,
        #financialTable tbody tr td:nth-child(2) {
            background-color: #f8f9fa !important;
            color: #212529 !important;
        }
        
        /* Garantir que as colunas fixas tenham prioridade sobre outras classes */
        #financialTable .table-dark th:first-child,
        #financialTable .table-dark th:nth-child(2) {
            background-color: #343a40 !important;
            color: #ffffff !important;
        }
        
        /* CORRE√á√ÉO PARA TABELA DE A√á√ïES - Replicar as mesmas corre√ß√µes */
        #acoesTable thead tr th:first-child,
        #acoesTable thead tr th:nth-child(2) {
            background-color: #343a40 !important;
            color: #ffffff !important;
        }
        
        #acoesTable tbody tr td:first-child,
        #acoesTable tbody tr td:nth-child(2) {
            background-color: #f8f9fa !important;
            color: #212529 !important;
        }
        
        /* Garantir que as colunas fixas da tabela de a√ß√µes tenham prioridade */
        #acoesTable .table-dark th:first-child,
        #acoesTable .table-dark th:nth-child(2) {
            background-color: #343a40 !important;
            color: #ffffff !important;
        }
        
        /* Ajustar posicionamento das colunas fixas da tabela de a√ß√µes */
        #acoesTable th:first-child, #acoesTable td:first-child {
            min-width: 40px;
            position: sticky;
            left: 0;
            background-color: #f8f9fa !important;
            z-index: 1;
            border-right: 2px solid #dee2e6;
        }
        
        #acoesTable th:nth-child(2), #acoesTable td:nth-child(2) {
            min-width: 80px;
            position: sticky;
            left: 40px;
            background-color: #f8f9fa !important;
            z-index: 1;
            border-right: 2px solid #dee2e6;
        }
        
        /* CORRE√á√ÉO PARA TABELA DE PROVENTOS - Todas as colunas com fundo correto */
        #proventosTable thead tr th {
            background-color: #343a40 !important;
            color: #ffffff !important;
        }
        
        #proventosTable tbody tr td {
            background-color: inherit !important;
            color: inherit !important;
        }
        
        /* Coluna Ano fixa com fundo espec√≠fico */
        #proventosTable thead tr th:first-child {
            position: sticky;
            left: 0;
            z-index: 2;
            border-right: 2px solid #dee2e6;
        }
        
        #proventosTable tbody tr td:first-child {
            background-color: #f8f9fa !important;
            color: #212529 !important;
            position: sticky;
            left: 0;
            z-index: 2;
            border-right: 2px solid #dee2e6;
        }
        
        /* Garantir que todas as colunas tenham fundo correto */
        #proventosTable .table-dark th {
            background-color: #343a40 !important;
            color: #ffffff !important;
        }
        
        #proventosTable .table-striped tbody tr:nth-of-type(odd) td {
            background-color: rgba(0, 0, 0, 0.05) !important;
        }
        
        #proventosTable .table-striped tbody tr:nth-of-type(even) td {
            background-color: rgba(0, 0, 0, 0) !important;
        }
        
        #proventosTable .table-hover tbody tr:hover td {
            background-color: rgba(0, 0, 0, 0.075) !important;
        }
        
                 /* Estilos para tabela de a√ß√µes no dashboard */
         #acoesTableDashboard thead tr th:first-child,
         #acoesTableDashboard thead tr th:nth-child(2) {
             background-color: #343a40 !important;
             color: #ffffff !important;
             position: sticky;
             left: 0;
             z-index: 2;
         }
         
         #acoesTableDashboard tbody tr td:first-child,
         #acoesTableDashboard tbody tr td:nth-child(2) {
             background-color: #f8f9fa !important;
             color: #212529 !important;
             position: sticky;
             left: 0;
             z-index: 2;
         }
         
         #acoesTableDashboard th:first-child, #acoesTableDashboard td:first-child {
             border-right: 2px solid #dee2e6;
         }
         
         #acoesTableDashboard th:nth-child(2), #acoesTableDashboard td:nth-child(2) {
             border-right: 2px solid #dee2e6;
         }
         
         /* Ajustar largura da tabela para acomodar todas as colunas */
         #acoesTableDashboard {
             min-width: 1400px;
         }
         
         /* Ajustar largura das colunas para melhor visualiza√ß√£o */
         #acoesTableDashboard th,
         #acoesTableDashboard td {
             min-width: 120px;
             max-width: 150px;
             white-space: nowrap;
             overflow: hidden;
             text-overflow: ellipsis;
         }
         
         #acoesTableDashboard th:first-child,
         #acoesTableDashboard td:first-child {
             min-width: 60px;
             max-width: 80px;
         }
         
         #acoesTableDashboard th:nth-child(2),
         #acoesTableDashboard td:nth-child(2) {
             min-width: 80px;
             max-width: 100px;
         }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row bg-primary text-white py-3 mb-3">
            <div class="col-12">
                <h1 class="text-center mb-0">
                    <i class="fas fa-chart-line me-3"></i>
                    Sistema de Gest√£o Financeira Pessoal
                </h1>
            </div>
        </div>

        <!-- Upload Section (Reduzida) -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-body py-2">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="upload-area" id="uploadArea">
                                    <i class="fas fa-file-excel fa-2x text-primary me-2"></i>
                                    <span class="me-3">Arraste e solte sua planilha Excel aqui</span>
                                    <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
                                    <button class="btn btn-primary btn-sm" onclick="document.getElementById('fileInput').click()">
                                        <i class="fas fa-folder-open me-1"></i>
                                        Selecionar Arquivo
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-outline-secondary btn-sm" onclick="loadDefaultData()">
                                    <i class="fas fa-database me-1"></i>
                                    Carregar Dados Padr√£o
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div class="row loading" id="loadingIndicator">
            <div class="col-12 text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-2">Processando dados financeiros...</p>
            </div>
        </div>

        <!-- Data Display Section -->
        <div class="row" id="dataSection" style="display: none;">
            <!-- Navigation Tabs -->
            <div class="col-12 mb-3">
                <ul class="nav nav-tabs" id="mainTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">
                            <i class="fas fa-chart-pie me-2"></i>Dashboard
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="proventos-tab" data-bs-toggle="tab" data-bs-target="#proventos" type="button" role="tab">
                            <i class="fas fa-money-bill-wave me-2"></i>Proventos
                        </button>
                    </li>
                                         <li class="nav-item" role="presentation">
                         <button class="nav-link" id="cartao-tab" data-bs-toggle="tab" data-bs-target="#cartao" type="button" role="tab">
                             <i class="fas fa-credit-card me-2"></i>Cart√£o
                         </button>
                     </li>

                     <li class="nav-item" role="presentation">
                         <button class="nav-link" id="table-tab" data-bs-toggle="tab" data-bs-target="#table" type="button" role="tab">
                             <i class="fas fa-table me-2"></i>Tabela de Dados
                         </button>
                     </li>
                </ul>
            </div>

            <!-- Tab Content -->
            <div class="tab-content" id="mainTabsContent">
                <!-- Dashboard Tab -->
                <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                    <div class="row mb-4">
                        <!-- Consolidado Chart -->
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-chart-bar me-2"></i>
                                        Consolidado
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="consolidatedChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Investimento Chart -->
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-chart-pie me-2"></i>
                                        Investimento
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="investimentoChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tabela de A√ß√µes -->
                    <div class="row mb-4">
                        <!-- Carteira de A√ß√µes -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-chart-pie me-2"></i>
                                        Carteira de A√ß√µes
                                    </h5>
                                </div>
                                <div class="card-body">
                                                                         <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                                                                 <table class="table table-sm table-striped table-hover table-bordered" id="acoesTableDashboard">
                                             <thead class="table-dark">
                                                 <tr>
                                                     <th scope="col" style="min-width: 40px;">Ticker</th>
                                                     <th scope="col" style="min-width: 80px;">Qtd</th>
                                                     <th scope="col" style="min-width: 140px;">Div. Esperado 2025</th>
                                                     <th scope="col" style="min-width: 140px;">Renda Esperada</th>
                                                     <th scope="col" style="min-width: 140px;">Capital Atual</th>
                                                     <th scope="col" style="min-width: 140px;">Dividend Yield Esperado</th>
                                                     <th scope="col" style="min-width: 140px;">Dividend Yield Pago</th>
                                                     <th scope="col" style="min-width: 140px;">Propor√ß√£o Hoje</th>
                                                     <th scope="col" style="min-width: 140px;">Meta 28k</th>
                                                     <th scope="col" style="min-width: 140px;">Meta +1.a.</th>
                                                     <th scope="col" style="min-width: 140px;">Meta qtd. 2033</th>
                                                 </tr>
                                             </thead>
                                             <tbody id="acoesTableDashboardBody">
                                             </tbody>
                                         </table>
                                    </div>
                                    <div class="mt-3">
                                        <div class="row text-center">
                                            <div class="col-md-12">
                                                <div class="bg-light p-3 rounded">
                                                    <h6 class="text-muted mb-1">Renda Total</h6>
                                                    <h5 class="text-success mb-0" id="rendaTotalDashboard">R$ 0,00</h5>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>



                <!-- Proventos Tab -->
                <div class="tab-pane fade" id="proventos" role="tabpanel">
                    <div class="row mb-4">
                        <!-- Filtros -->
                        <div class="col-12 mb-3">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-filter me-2"></i>
                                        Filtros de Per√≠odo
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <button class="btn btn-outline-success w-100" onclick="filterProventos('este-ano')">
                                                <i class="fas fa-calendar-day me-2"></i>
                                                Este Ano
                                            </button>
                                        </div>
                                        <div class="col-md-4">
                                            <button class="btn btn-outline-info w-100" onclick="filterProventos('ultimos-12-meses')">
                                                <i class="fas fa-calendar-week me-2"></i>
                                                √öltimos 12 Meses
                                            </button>
                                        </div>
                                        <div class="col-md-4">
                                            <button class="btn btn-outline-primary w-100" onclick="filterProventos('desde-inicio')">
                                                <i class="fas fa-calendar-alt me-2"></i>
                                                Desde o In√≠cio
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Gr√°fico de Proventos -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-chart-line me-2"></i>
                                        Evolu√ß√£o dos Proventos
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="proventosChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tabela de Proventos -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-table me-2"></i>
                                        Tabela de Proventos por Ano
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover table-bordered" id="proventosTable">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th scope="col">Ano</th>
                                                    <th scope="col">Janeiro</th>
                                                    <th scope="col">Fevereiro</th>
                                                    <th scope="col">Mar√ßo</th>
                                                    <th scope="col">Abril</th>
                                                    <th scope="col">Maio</th>
                                                    <th scope="col">Junho</th>
                                                    <th scope="col">Julho</th>
                                                    <th scope="col">Agosto</th>
                                                    <th scope="col">Setembro</th>
                                                    <th scope="col">Outubro</th>
                                                    <th scope="col">Novembro</th>
                                                    <th scope="col">Dezembro</th>
                                                    <th scope="col">Total</th>
                                                </tr>
                                            </thead>
                                            <tbody id="proventosTableBody">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                                 <!-- Cart√£o Tab -->
                 <div class="tab-pane fade" id="cartao" role="tabpanel">
                     <div class="row mb-4">
                         <!-- Gr√°fico de Cart√£o -->
                         <div class="col-12 mb-4">
                             <div class="card">
                                 <div class="card-header bg-warning text-dark">
                                     <h5 class="mb-0">
                                         <i class="fas fa-credit-card me-2"></i>
                                         Gastos com Cart√£o por Institui√ß√£o
                                     </h5>
                                 </div>
                                 <div class="card-body">
                                     <div class="chart-container">
                                         <canvas id="cartaoChart"></canvas>
                                     </div>
                                 </div>
                             </div>
                         </div>

                         <!-- Filtros -->
                         <div class="col-12 mb-3">
                             <div class="card">
                                 <div class="card-header bg-primary text-white">
                                     <h5 class="mb-0">
                                         <i class="fas fa-filter me-2"></i>
                                         Filtros
                                     </h5>
                                 </div>
                                 <div class="card-body">
                                     <div class="row">
                                         <div class="col-md-6">
                                             <label for="filtroMes" class="form-label">Filtrar por M√™s:</label>
                                             <select class="form-select" id="filtroMes" onchange="filtrarCartaoDetalhe()">
                                                 <option value="">Todos os meses</option>
                                             </select>
                                         </div>
                                         <div class="col-md-6">
                                             <label for="filtroGrupo" class="form-label">Filtrar por Categoria:</label>
                                             <select class="form-select" id="filtroGrupo" onchange="filtrarCartaoDetalhe()">
                                                 <option value="">Todas as categorias</option>
                                             </select>
                                         </div>
                                     </div>
                                 </div>
                             </div>
                         </div>

                         <!-- Gr√°fico de Cart√£o por Categoria -->
                         <div class="col-12 mb-4">
                             <div class="card">
                                 <div class="card-header bg-primary text-white">
                                     <h5 class="mb-0">
                                         <i class="fas fa-chart-bar me-2"></i>
                                         Gastos por Categoria - M√™s a M√™s
                                     </h5>
                                 </div>
                                 <div class="card-body">
                                     <div class="chart-container">
                                         <canvas id="cartaoCategoriaChart"></canvas>
                                     </div>
                                 </div>
                             </div>
                         </div>

                         <!-- Tabela de Cart√£o Detalhado -->
                         <div class="col-12">
                             <div class="card">
                                 <div class="card-header bg-primary text-white">
                                     <h5 class="mb-0">
                                         <i class="fas fa-table me-2"></i>
                                         Detalhamento de Faturas
                                     </h5>
                                 </div>
                                 <div class="card-body">
                                     <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                         <table class="table table-sm table-striped table-hover table-bordered" id="cartaoDetalheTable">
                                             <thead class="table-dark">
                                                 <tr>
                                                     <th scope="col">Fatura</th>
                                                     <th scope="col">Data</th>
                                                     <th scope="col">Estabelecimento</th>
                                                     <th scope="col">Valor</th>
                                                     <th scope="col">Cart√£o</th>
                                                     <th scope="col">Categoria</th>
                                                 </tr>
                                             </thead>
                                             <tbody id="cartaoDetalheTableBody">
                                             </tbody>
                                         </table>
                                     </div>
                                 </div>
                             </div>
                         </div>
                     </div>
                 </div>




                <!-- Table Tab -->
                <div class="tab-pane fade" id="table" role="tabpanel">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-table me-2"></i>
                                    Dados Financeiros Detalhados
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover table-bordered" id="financialTable">
                                        <thead class="table-dark">
                                            <tr>
                                                <th scope="col" style="min-width: 200px;">Categoria</th>
                                                <th scope="col" style="min-width: 100px;">ID</th>
                                                <!-- Os cabe√ßalhos dos meses ser√£o criados dinamicamente -->
                                            </tr>
                                        </thead>
                                        <tbody id="tableBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
                 let currentData = null;
         let consolidatedChart = null;
         let cartaoChart = null;
         let investimentoChart = null;
         let proventosChart = null;
         let cartaoCategoriaChart = null;
         let currentProventosFilter = 'desde-inicio';

        // Fun√ß√£o para obter o m√™s atual
        function getCurrentMonth() {
            const now = new Date();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            return `25-${month}`;
        }

        // Fun√ß√£o para verificar se o m√™s √© futuro
        function isFutureMonth(monthStr) {
            const currentMonth = getCurrentMonth();
            return monthStr > currentMonth; // Maior que o m√™s atual (n√£o igual)
        }

        // Drag and Drop functionality
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                alert('Por favor, selecione um arquivo Excel v√°lido (.xlsx ou .xls)');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            showLoading(true);

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                if (data.success) {
                    displayData(data);
                } else {
                    alert('Erro ao processar arquivo: ' + data.error);
                }
            })
            .catch(error => {
                showLoading(false);
                alert('Erro ao fazer upload: ' + error.message);
            });
        }

        function loadDefaultData() {
            showLoading(true);
            
            fetch('/load_default')
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                if (data.success) {
                    displayData(data);
                } else {
                    alert('Erro ao carregar dados padr√£o: ' + data.error);
                }
            })
            .catch(error => {
                showLoading(false);
                alert('Erro ao carregar dados: ' + error.message);
            });
        }

        function displayData(data) {
            console.log('üîç displayData chamada com:', data);
            currentData = data;
            
            // Display data section
            document.getElementById('dataSection').style.display = 'block';
            
            // Create charts
            createConsolidatedChart(data.chart_data);
            createCartaoChart(data.chart_data);
            createInvestimentoChart(data.chart_data);
            
            // Create table
            createFinancialTable(data.table_data, data.chart_data.months);
            
            // Create a√ß√µes table
            if (data.acoes_data) {
                console.log('üîç Criando tabela de a√ß√µes com:', data.acoes_data);
                createAcoesTableDashboard(data.acoes_data);
            } else {
                console.log('‚ùå data.acoes_data n√£o encontrado');
            }
            
                         // Create proventos chart and table
             if (data.proventos_data) {
                 console.log('üîç Criando tabela de proventos com:', data.proventos_data);
                 createProventosChart(data.proventos_data);
                 createProventosTable(data.proventos_data);
             } else {
                 console.log('‚ùå data.proventos_data n√£o encontrado');
             }
             
             // Create cart√£o detalhado chart and table
             if (data.cartao_data && data.cartao_detalhe_data) {
                 console.log('üîç Criando cart√£o detalhado com:', data.cartao_data, data.cartao_detalhe_data);
                 createCartaoCategoriaChart(data.cartao_data);
                 createCartaoDetalheTable(data.cartao_detalhe_data);
                 populateCartaoFilters(data.cartao_data, data.cartao_detalhe_data);
             } else {
                 console.log('‚ùå data.cartao_data ou data.cartao_detalhe_data n√£o encontrado');
             }
        }

        function createConsolidatedChart(chartData) {
            console.log('üîç createConsolidatedChart chamada com:', chartData);
            
            const canvas = document.getElementById('consolidatedChart');
            if (!canvas) {
                console.error('‚ùå Elemento consolidatedChart n√£o encontrado');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            if (consolidatedChart) {
                consolidatedChart.destroy();
            }

            // Preparar dados com cores baseadas no m√™s
            const months = chartData.months;
            const currentMonth = getCurrentMonth();
            
            const datasets = [
                {
                    label: 'Cr√©dito Realizado',
                    data: chartData.consolidated.credito_realizado,
                    backgroundColor: 'rgba(40, 167, 69, 0.8)',
                    borderColor: 'rgba(40, 167, 69, 1)',
                    borderWidth: 1
                }
            ];

            // Adicionar D√©bitos Realizado (meses passados)
            const debitosRealizadoData = months.map((month, index) => {
                return isFutureMonth(month) ? 0 : chartData.consolidated.debitos_realizado[index];
            });
            
            datasets.push({
                label: 'D√©bitos Realizado',
                data: debitosRealizadoData,
                backgroundColor: 'rgba(220, 53, 69, 0.8)',
                borderColor: 'rgba(220, 53, 69, 1)',
                borderWidth: 1
            });

            // Adicionar D√©bitos Previsto (meses futuros) em cinza
            const debitosPrevistoData = months.map((month, index) => {
                return isFutureMonth(month) ? chartData.consolidated.debitos_previsto[index] : 0;
            });
            
            datasets.push({
                label: 'D√©bitos Previsto',
                data: debitosPrevistoData,
                backgroundColor: 'rgba(108, 117, 125, 0.8)',
                borderColor: 'rgba(108, 117, 125, 1)',
                borderWidth: 1
            });

            // Adicionar linha consolidada
            datasets.push({
                label: '[C] Consolidado',
                data: chartData.consolidated.consolidado,
                type: 'line',
                borderColor: 'rgba(0, 123, 255, 1)',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.1
            });

            consolidatedChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Evolu√ß√£o Financeira Consolidada'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += 'R$ ' + context.parsed.y.toLocaleString('pt-BR');
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toLocaleString('pt-BR');
                                }
                            }
                        }
                    }
                }
            });
        }

        function createCartaoChart(chartData) {
            console.log('üîç createCartaoChart chamada com:', chartData);
            
            const canvas = document.getElementById('cartaoChart');
            if (!canvas) {
                console.error('‚ùå Elemento cartaoChart n√£o encontrado');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            if (cartaoChart) {
                cartaoChart.destroy();
            }

            // Preparar dados com l√≥gica de meses futuros
            const months = chartData.months;
            const datasets = [];

            // Para meses passados e atual: usar dados realizados
            const cartaoDtiData = months.map((month, index) => {
                return isFutureMonth(month) ? 0 : chartData.cartao.cartao_dti[index];
            });
            
            datasets.push({
                label: 'Cart√£o dti Realizado',
                data: cartaoDtiData,
                backgroundColor: 'rgba(255, 193, 7, 0.8)',
                borderColor: 'rgba(255, 193, 7, 1)',
                borderWidth: 1
            });

            const sicrediData = months.map((month, index) => {
                return isFutureMonth(month) ? 0 : chartData.cartao.sicredi[index];
            });
            
            datasets.push({
                label: 'Sicredi Realizado',
                data: sicrediData,
                backgroundColor: 'rgba(220, 53, 69, 0.8)',
                borderColor: 'rgba(220, 53, 69, 1)',
                borderWidth: 1
            });

            const portoBankData = months.map((month, index) => {
                return isFutureMonth(month) ? 0 : chartData.cartao.porto_bank[index];
            });
            
            datasets.push({
                label: 'Porto Bank Realizado',
                data: portoBankData,
                backgroundColor: 'rgba(23, 162, 184, 0.8)',
                borderColor: 'rgba(23, 162, 184, 1)',
                borderWidth: 1
            });

            const btgData = months.map((month, index) => {
                return isFutureMonth(month) ? 0 : chartData.cartao.btg[index];
            });
            
            datasets.push({
                label: 'BTG Realizado',
                data: btgData,
                backgroundColor: 'rgba(102, 16, 242, 0.8)',
                borderColor: 'rgba(102, 16, 242, 1)',
                borderWidth: 1
            });

            // Para meses futuros: usar [C] Cart√£o em cinza
            const cartaoConsolidadoData = months.map((month, index) => {
                return isFutureMonth(month) ? chartData.cartao.cartao_consolidado[index] : 0;
            });
            
            datasets.push({
                label: '[C] Cart√£o (Futuro)',
                data: cartaoConsolidadoData,
                backgroundColor: 'rgba(108, 117, 125, 0.8)',
                borderColor: 'rgba(108, 117, 125, 1)',
                borderWidth: 1
            });

            cartaoChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Gastos com Cart√£o por Institui√ß√£o'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += 'R$ ' + context.parsed.y.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toLocaleString('pt-BR');
                                }
                            }
                        }
                    }
                }
            });
        }

        function createInvestimentoChart(chartData) {
            console.log('üîç createInvestimentoChart chamada com:', chartData);
            
            const canvas = document.getElementById('investimentoChart');
            if (!canvas) {
                console.error('‚ùå Elemento investimentoChart n√£o encontrado');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            if (investimentoChart) {
                investimentoChart.destroy();
            }

            investimentoChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.months,
                    datasets: [
                        {
                            label: 'Investimento A√ß√µes',
                            data: chartData.investimento.acoes,
                            backgroundColor: 'rgba(255, 99, 132, 0.8)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Investimento Renda Fixa',
                            data: chartData.investimento.renda_fixa,
                            backgroundColor: 'rgba(54, 162, 235, 0.8)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Previd√™ncia Privada',
                            data: chartData.investimento.previdencia_privada,
                            backgroundColor: 'rgba(75, 192, 192, 0.8)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Evolu√ß√£o dos Investimentos'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += 'R$ ' + context.parsed.y.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toLocaleString('pt-BR');
                                }
                            }
                        }
                    }
                }
            });
        }

        function createFinancialTable(tableData, months) {
            console.log('üîç createFinancialTable chamada com:', tableData, months);
            
            const tableBody = document.getElementById('tableBody');
            const thead = document.querySelector('#financialTable thead tr');
            
            if (!tableBody || !thead) {
                console.error('‚ùå Elementos da tabela financeira n√£o encontrados');
                return;
            }
            
            // Limpar cabe√ßalhos existentes (exceto Categoria e ID)
            const existingHeaders = thead.querySelectorAll('th');
            for (let i = 2; i < existingHeaders.length; i++) {
                existingHeaders[i].remove();
            }
            
            // Adicionar cabe√ßalhos dos meses
            months.forEach(month => {
                const th = document.createElement('th');
                th.setAttribute('scope', 'col');
                th.className = 'text-center';
                th.style.minWidth = '100px';
                
                if (isFutureMonth(month)) {
                    th.classList.add('month-future');
                }
                
                th.textContent = month;
                thead.appendChild(th);
            });
            
            // Limpar o corpo da tabela
            tableBody.innerHTML = '';
            
            // Criar linhas da tabela
            tableData.forEach(row => {
                const tr = document.createElement('tr');
                
                // C√©lula da categoria
                const tdCategory = document.createElement('td');
                tdCategory.innerHTML = `<span class="badge bg-secondary">${row.alias}</span>`;
                tr.appendChild(tdCategory);
                
                // C√©lula do ID
                const tdId = document.createElement('td');
                tdId.innerHTML = `<small class="text-muted">${row.id}</small>`;
                tr.appendChild(tdId);
                
                // C√©lulas dos meses
                months.forEach(month => {
                    const td = document.createElement('td');
                    td.className = 'text-end';
                    
                    const value = row.months[month];
                    let valueClass = '';
                    if (value > 0) valueClass = 'text-success fw-bold';
                    else if (value < 0) valueClass = 'text-danger fw-bold';
                    else valueClass = 'text-muted';
                    
                    if (isFutureMonth(month)) {
                        td.classList.add('month-future');
                        // Remover classes de cor para meses futuros para manter consist√™ncia
                        td.className = 'text-end month-future';
                    } else {
                        if (valueClass) td.className += ' ' + valueClass;
                    }
                    
                    td.textContent = `R$ ${value.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                    tr.appendChild(td);
                });
                
                tableBody.appendChild(tr);
            });
        }

        function createAcoesTableDashboard(acoesData) {
            console.log('üîç createAcoesTableDashboard chamada com:', acoesData);
            
            const acoesTableBody = document.getElementById('acoesTableDashboardBody');
            const rendaTotal = document.getElementById('rendaTotalDashboard');
            
            console.log('üîç Elementos encontrados:');
            console.log('  - acoesTableBody:', acoesTableBody);
            console.log('  - rendaTotal:', rendaTotal);

            if (!acoesTableBody || !rendaTotal) {
                console.error('‚ùå Elementos da tabela de a√ß√µes n√£o encontrados');
                return;
            }

             if (!acoesData || acoesData.length === 0) {
                 acoesTableBody.innerHTML = `
                     <tr>
                         <td colspan="11" class="text-center text-muted">
                             <i class="fas fa-info-circle me-2"></i>
                             Nenhuma a√ß√£o encontrada. Adicione dados na aba "A√ß√µes" do Excel.
                         </td>
                     </tr>
                 `;
                 rendaTotal.textContent = 'R$ 0,00';
                 return;
             }

            let totalRenda = 0;

            acoesData.forEach(acao => {
                totalRenda += acao.renda_esperada;
            });

            rendaTotal.textContent = `R$ ${totalRenda.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;

                         acoesTableBody.innerHTML = acoesData.map(acao => {
                 return `
                     <tr>
                         <td><strong>${acao.ticker}</strong></td>
                         <td class="text-end">${acao.qtd.toLocaleString('pt-BR')}</td>
                         <td class="text-end text-success">R$ ${(acao.div_esperado_2025 || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                         <td class="text-end text-success">R$ ${acao.renda_esperada.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                         <td class="text-end text-primary">R$ ${(acao.capital_atual || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                         <td class="text-end text-info">${(acao.dividend_yield_esperado || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}%</td>
                         <td class="text-end text-warning">R$ ${(acao.dividend_yield_pago || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                         <td class="text-end text-secondary">${((acao.proporcao_hoje || 0) * 100).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}%</td>
                         <td class="text-end text-dark">R$ ${(acao.meta_28k || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                         <td class="text-end text-dark">R$ ${(acao.meta_1_ano || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                         <td class="text-end text-dark">${(acao.meta_qtd_2033 || 0).toLocaleString('pt-BR')}</td>
                     </tr>
                 `;
             }).join('');
        }



        function createProventosChart(proventosData) {
            console.log('üîç createProventosChart chamada com:', proventosData);
            
            const canvas = document.getElementById('proventosChart');
            if (!canvas) {
                console.error('‚ùå Elemento proventosChart n√£o encontrado');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            if (proventosChart) {
                proventosChart.destroy();
            }

            // Aplicar filtro atual
            const filteredData = filterProventosData(proventosData, currentProventosFilter);
            
            // Preparar dados para gr√°fico de barras com meses no eixo X
            const monthNames = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                               'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            
            // Criar datasets para cada ano
            const datasets = [];
            const colors = [
                'rgba(40, 167, 69, 0.8)',   // Verde
                'rgba(23, 162, 184, 0.8)',  // Azul
                'rgba(255, 193, 7, 0.8)',   // Amarelo
                'rgba(220, 53, 69, 0.8)',   // Vermelho
                'rgba(102, 16, 242, 0.8)',  // Roxo
                'rgba(253, 126, 20, 0.8)',  // Laranja
                'rgba(32, 201, 151, 0.8)'   // Verde √°gua
            ];
            
            filteredData.forEach((yearData, index) => {
                
                const yearValues = monthNames.map(monthName => {
                    const value = yearData.months[monthName] || 0;
                    return value;
                });
                
                datasets.push({
                    label: `Ano ${yearData.year}`,
                    data: yearValues,
                    backgroundColor: colors[index % colors.length],
                    borderColor: colors[index % colors.length].replace('0.8', '1'),
                    borderWidth: 1
                });
            });
            
            const chartConfig = {
                type: 'bar',
                data: {
                    labels: monthNames,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Evolu√ß√£o dos Proventos por M√™s'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += 'R$ ' + context.parsed.y.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Meses'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Valor (R$)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toLocaleString('pt-BR');
                                }
                            }
                        }
                    }
                }
            };
            
            try {
                proventosChart = new Chart(ctx, chartConfig);
            } catch (error) {
                console.error('‚ùå Erro ao criar gr√°fico:', error);
            }
        }

        function createProventosTable(proventosData) {
            console.log('üîç createProventosTable chamada com:', proventosData);
            
            const tableBody = document.getElementById('proventosTableBody');
            console.log('üîç tableBody encontrado:', tableBody);
            
            if (!tableBody) {
                console.error('‚ùå Elemento proventosTableBody n√£o encontrado');
                return;
            }
            
            // Aplicar filtro atual
            const filteredData = filterProventosData(proventosData, currentProventosFilter);
            
            tableBody.innerHTML = '';
            
            filteredData.forEach(yearData => {
                
                const tr = document.createElement('tr');
                
                // C√©lula do ano
                const tdYear = document.createElement('td');
                tdYear.innerHTML = `<strong>${yearData.year}</strong>`;
                tr.appendChild(tdYear);
                
                // C√©lulas dos meses
                const monthNames = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                                   'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                
                monthNames.forEach(monthName => {
                    const td = document.createElement('td');
                    td.className = 'text-end';
                    
                    // Encontrar o valor do m√™s correspondente
                    let monthValue = yearData.months[monthName] || 0;
                    
                    if (monthValue > 0) {
                        td.className += ' text-success fw-bold';
                    } else if (monthValue < 0) {
                        td.className += ' text-danger fw-bold';
                    } else {
                        td.className += ' text-muted';
                    }
                    
                    td.textContent = `R$ ${monthValue.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                    tr.appendChild(td);
                });
                
                // C√©lula do total
                const tdTotal = document.createElement('td');
                tdTotal.className = 'text-end fw-bold';
                if (yearData.total > 0) {
                    tdTotal.className += ' text-success';
                } else if (yearData.total < 0) {
                    tdTotal.className += ' text-danger';
                }
                tdTotal.textContent = `R$ ${yearData.total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                tr.appendChild(tdTotal);
                
                tableBody.appendChild(tr);
            });
            
        }

        function filterProventos(filterType) {
            currentProventosFilter = filterType;
            
            if (currentData && currentData.proventos_data) {
                createProventosChart(currentData.proventos_data);
                createProventosTable(currentData.proventos_data);
            }
        }

        function filterProventosData(proventosData, filterType) {
            
            if (!proventosData || proventosData.length === 0) {
                return [];
            }
            
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;
            
            let filteredData = [];
            
            switch (filterType) {
                case 'este-ano':
                    filteredData = proventosData.filter(item => item.year === currentYear);
                    break;
                
                case 'ultimos-12-meses':
                    // Para os √∫ltimos 12 meses, vamos mostrar os √∫ltimos 2 anos
                    filteredData = proventosData.filter(item => 
                        item.year >= currentYear - 1
                    );
                    break;
                
                case 'desde-inicio':
                default:
                    filteredData = proventosData;
                    break;
            }
            
            return filteredData;
        }

        function showLoading(show) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (show) {
                loadingIndicator.classList.add('show');
            } else {
                loadingIndicator.classList.remove('show');
            }
        }

                 // Auto-load default data on page load
         window.addEventListener('load', () => {
             loadDefaultData();
         });

         // Fun√ß√µes para Cart√£o Detalhado
         function createCartaoCategoriaChart(cartaoData) {
             console.log('üîç createCartaoCategoriaChart chamada com:', cartaoData);
             
             const canvas = document.getElementById('cartaoCategoriaChart');
             if (!canvas) {
                 console.error('‚ùå Elemento cartaoCategoriaChart n√£o encontrado');
                 return;
             }
             
             const ctx = canvas.getContext('2d');
             
             if (cartaoCategoriaChart) {
                 cartaoCategoriaChart.destroy();
             }

             // Preparar dados para gr√°fico de barras
             const months = Object.keys(cartaoData[0]?.months || {}).sort();
             const grupos = cartaoData.map(item => item.grupo);
             
             // Se n√£o h√° meses ou grupos, n√£o criar gr√°fico
             if (months.length === 0 || grupos.length === 0) {
                 console.warn('‚ö†Ô∏è Dados insuficientes para criar gr√°fico');
                 return;
             }
             
             const datasets = grupos.map((grupo, index) => {
                 const colors = [
                     'rgba(255, 99, 132, 0.8)',   // Vermelho
                     'rgba(54, 162, 235, 0.8)',   // Azul
                     'rgba(255, 206, 86, 0.8)',   // Amarelo
                     'rgba(75, 192, 192, 0.8)',   // Verde √°gua
                     'rgba(153, 102, 255, 0.8)',  // Roxo
                     'rgba(255, 159, 64, 0.8)',   // Laranja
                     'rgba(199, 199, 199, 0.8)',  // Cinza
                     'rgba(83, 102, 255, 0.8)',   // Azul escuro
                     'rgba(78, 205, 196, 0.8)',   // Verde
                     'rgba(255, 99, 132, 0.8)'    // Rosa
                 ];
                 
                 const data = months.map(month => {
                     const grupoItem = cartaoData.find(item => item.grupo === grupo);
                     return grupoItem ? (grupoItem.months[month] || 0) : 0;
                 });
                 
                 return {
                     label: grupo,
                     data: data,
                     backgroundColor: colors[index % colors.length],
                     borderColor: colors[index % colors.length].replace('0.8', '1'),
                     borderWidth: 1
                 };
             });

             cartaoCategoriaChart = new Chart(ctx, {
                 type: 'bar',
                 data: {
                     labels: months.map(month => {
                         const [year, monthNum] = month.split('-');
                         const monthNames = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 
                                           'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                         return `${monthNames[parseInt(monthNum) - 1]}/${year.slice(-2)}`;
                     }),
                     datasets: datasets
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false,
                     plugins: {
                         title: {
                             display: true,
                             text: 'Gastos por Categoria - M√™s a M√™s'
                         },
                         tooltip: {
                             callbacks: {
                                 label: function(context) {
                                     let label = context.dataset.label || '';
                                     if (label) {
                                         label += ': ';
                                     }
                                     if (context.parsed.y !== null) {
                                         label += 'R$ ' + context.parsed.y.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                                     }
                                     return label;
                                 }
                             }
                         }
                     },
                     scales: {
                         x: {
                             title: {
                                 display: true,
                                 text: 'Meses'
                             }
                         },
                         y: {
                             beginAtZero: true,
                             title: {
                                 display: true,
                                 text: 'Valor (R$)'
                             },
                             ticks: {
                                 callback: function(value) {
                                     return 'R$ ' + value.toLocaleString('pt-BR');
                                 }
                             }
                         }
                     }
                 }
             });
         }

         function createCartaoDetalheTable(cartaoDetalheData) {
             console.log('üîç createCartaoDetalheTable chamada com:', cartaoDetalheData);
             
             const tableBody = document.getElementById('cartaoDetalheTableBody');
             if (!tableBody) {
                 console.error('‚ùå Elemento cartaoDetalheTableBody n√£o encontrado');
                 return;
             }
             
             // Armazenar dados originais para filtros
             window.originalCartaoDetalheData = cartaoDetalheData;
             
             // Exibir todos os dados inicialmente
             displayFilteredCartaoDetalhe(cartaoDetalheData);
         }

         function populateCartaoFilters(cartaoData, cartaoDetalheData) {
             console.log('üîç populateCartaoFilters chamada com:', cartaoData, cartaoDetalheData);
             
             const filtroMes = document.getElementById('filtroMes');
             const filtroGrupo = document.getElementById('filtroGrupo');
             
             if (!filtroMes || !filtroGrupo) {
                 console.error('‚ùå Elementos de filtro n√£o encontrados');
                 return;
             }
             
             // Armazenar dados originais para uso nos filtros
             window.originalCartaoData = cartaoData;
             
             // Popular filtro de meses
             const months = Object.keys(cartaoData[0]?.months || {}).sort();
             filtroMes.innerHTML = '<option value="">Todos os meses</option>';
             months.forEach(month => {
                 const [year, monthNum] = month.split('-');
                 const monthNames = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                                   'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                 const monthName = monthNames[parseInt(monthNum) - 1];
                 const option = document.createElement('option');
                 option.value = month;
                 option.textContent = `${monthName}/${year.slice(-2)}`;
                 filtroMes.appendChild(option);
             });
             
             // Popular filtro de categorias
             const grupos = [...new Set(cartaoDetalheData.map(item => item.grupo))].sort();
             filtroGrupo.innerHTML = '<option value="">Todas as categorias</option>';
             grupos.forEach(grupo => {
                 const option = document.createElement('option');
                 option.value = grupo;
                 option.textContent = grupo;
                 filtroGrupo.appendChild(option);
             });
         }

         function filtrarCartaoDetalhe() {
             const filtroMes = document.getElementById('filtroMes').value;
             const filtroGrupo = document.getElementById('filtroGrupo').value;
             
             if (!window.originalCartaoDetalheData) {
                 console.error('‚ùå Dados originais n√£o encontrados');
                 return;
             }
             
             let filteredData = window.originalCartaoDetalheData;
             
             // Aplicar filtro de m√™s
             if (filtroMes) {
                 filteredData = filteredData.filter(item => {
                     // A coluna Fatura cont√©m o formato "2025-05-01 00:00:00"
                     // Vamos extrair apenas o ano-m√™s (2025-05)
                     const faturaDate = new Date(item.fatura);
                     const itemMonthKey = `${faturaDate.getFullYear()}-${(faturaDate.getMonth() + 1).toString().padStart(2, '0')}`;
                     return itemMonthKey === filtroMes;
                 });
             }
             
             // Aplicar filtro de categoria
             if (filtroGrupo) {
                 filteredData = filteredData.filter(item => item.grupo === filtroGrupo);
             }
             
             // Exibir dados filtrados na tabela
             displayFilteredCartaoDetalhe(filteredData);
             
             // Atualizar gr√°fico com dados filtrados
             if (window.originalCartaoData) {
                 updateCartaoCategoriaChartWithFilters(filtroMes, filtroGrupo);
             }
         }

         function displayFilteredCartaoDetalhe(filteredData) {
             const tableBody = document.getElementById('cartaoDetalheTableBody');
             if (!tableBody) {
                 console.error('‚ùå Elemento cartaoDetalheTableBody n√£o encontrado');
                 return;
             }
             
             if (!filteredData || filteredData.length === 0) {
                 tableBody.innerHTML = `
                     <tr>
                         <td colspan="6" class="text-center text-muted">
                             <i class="fas fa-info-circle me-2"></i>
                             Nenhum registro encontrado com os filtros aplicados.
                         </td>
                     </tr>
                 `;
                 return;
             }
             
             tableBody.innerHTML = filteredData.map(item => {
                 const valorClass = item.valor > 0 ? 'text-danger' : 'text-success';
                 return `
                     <tr>
                         <td><strong>${item.fatura}</strong></td>
                         <td>${item.data}</td>
                         <td>${item.estabelecimento_fmt || item.estabelecimento}</td>
                         <td class="text-end ${valorClass}">R$ ${item.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                         <td>${item.cartao}</td>
                         <td><span class="badge bg-secondary">${item.grupo}</span></td>
                     </tr>
                 `;
             }).join('');
         }

         function updateCartaoCategoriaChartWithFilters(filtroMes, filtroGrupo) {
             if (!window.originalCartaoData) {
                 console.error('‚ùå Dados originais do cart√£o n√£o encontrados');
                 return;
             }
             
             let filteredCartaoData = window.originalCartaoData;
             
             // Aplicar filtro de categoria ao gr√°fico
             if (filtroGrupo) {
                 filteredCartaoData = filteredCartaoData.filter(item => item.grupo === filtroGrupo);
             }
             
             // Aplicar filtro de m√™s ao gr√°fico
             if (filtroMes) {
                 // Filtrar apenas o m√™s selecionado
                 const filteredData = filteredCartaoData.map(item => {
                     const filteredMonths = {};
                     filteredMonths[filtroMes] = item.months[filtroMes] || 0;
                     
                     return {
                         grupo: item.grupo,
                         months: filteredMonths
                     };
                 });
                 
                 // Recriar gr√°fico com dados filtrados
                 createCartaoCategoriaChart(filteredData);
             } else {
                 // Se n√£o h√° filtro de m√™s, mostrar todos os meses
                 createCartaoCategoriaChart(filteredCartaoData);
             }
         }
     </script>
</body>
</html>
